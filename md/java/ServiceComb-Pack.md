# 基于 ServiceComb-Pack 的分布式事务实战

## 什么是事务

> 简单讲事务是数据库管理系统执行过程中的一个逻辑单元，它能保证要么一组数据库操作全部执行成功，要么全部失败，而做到这些的原理就是事务的ACID四大特性。

### ACID

- 原子性（Atomicity）
    - 原子性是指事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败。比如在同一个事务中的SQL语句，要么全部执行成功，要么全部执行失败。
- 一致性（Consistency）
    - 事务必须使数据库从一个一致性状态变换到另外一个一致性状态。
    - 如转账，我有200，你有200，我向你转了100，转账成功的话你就是300，我是100；失败的话就回滚我还是200，你还是200，不能出现我100，你200的情况
- 隔离性（Isolation）
    - 事务的隔离性是多个用户并发访问数据库时，数据库为每一个用户开启的事务，不能被其他事务的操作数据所干扰，多个并发事务之间要相互隔离。
- 持久性（Durability）
    - 持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来即使数据库发生故障也不应该对其有任何影响。

## 单机事务

- 在传统单体应用架构中，我们的业务数据通常都是存储在一个数据库中的，应用中的各个模块对数据库直接进行操作。在这种场景中，事务是由数据库提供的基于ACID特性来保证的。

## 微服务的分布式下事务问题

-  微服务状态下，一个单体应用被拆分成多个服务，如商城系统被拆分成商品、订单、库存等多个服务，每个服务对应的数据库不同，每个服务的事务只能保证本地事务的ACID。如果订单服务下单成功了，库存服务扣量失败，而每个服务只会管理自己的事务，库存回滚不会导致订单回滚，从而导致数据不一致等问题。

## 分布式事务有哪些

-  2PC:（Two-phase commit protocol），中文叫二阶段提交。
    - 在计算机网络以及数据库领域内，二阶段提交（英语：Two-phase Commit）是指，为了使基于分布式系统架构下的所有节点在进行事务提交时保持一致性而设计的一种算法(Algorithm)。通常，二阶段提交也被称为是一种协议(Protocol)。在分布式系统中，每个节点虽然可以知晓自己的操作时成功或者失败，却无法知道其他节点的操作的成功或失败。当一个事务跨越多个节点时，为了保持事务的ACID特性，需要引入一个作为协调者的组件来统一掌控所有节点(称作参与者)的操作结果并最终指示这些节点是否要把操作结果进行真正的提交(比如将更新后的数据写入磁盘等等)。因此，二阶段提交的算法思路可以概括为： 参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是中止操作。
    - 说人话就是在两个或两个以上的服务中间出现一个协调者，服务称做参与者，协调者询问参与者是否可以进行事务提交，双方都回答是就可以提交，如果有一方回答否则全部回退
-  3PC: 中文叫三阶段提交。2PC的出现是为了解决 2PC 的一些问题，相比于 2PC 它在参与者中也引入了超时机制，并且新增了一个阶段使得参与者可以利用这一个阶段统一各自的状态。
    - 1PC 包含了三个阶段，分别是准备阶段、预提交阶段和提交阶段，对应的英文就是：CanCommit、PreCommit 和 DoCommit
- TCC: TCC 指的是Try - Confirm - Cancel。又称补偿事务。其核心思想是："针对每个操作都要注册一个与其对应的确认和补偿（撤销操作）"。
    - Try 指的是预留，即资源的预留和锁定，注意是预留。
    - Confirm 指的是确认操作，这一步其实就是真正的执行了。
    - Cancel 指的是撤销操作，可以理解为把预留阶段的动作撤销了。

## 分布式事务实操 华为开源分布式事务解决方案（待更新） —— ServiceComb-Pack

- https://github.com/apache/servicecomb-pack.git
- 注意：application.name一定不要过长，因为instanceId的格式是application.name+IP，并且长度为36，否则alpha-server事务持久化会报错
- sage-pack 官方设计文档 
- https://github.com/apache/servicecomb-pack/blob/master/docs/design_zh.md
     